<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Export - Kande VendTech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Category colors */
        .cat-snacks { background-color: #fef3c7; }
        .cat-candy { background-color: #fce7f3; }
        .cat-cold_beverage, .cat-beverages { background-color: #dbeafe; }
        .cat-hot_foods { background-color: #fee2e2; }
        .cat-refrigerated { background-color: #d1fae5; }
        .cat-frozen_foods { background-color: #e0e7ff; }
        
        /* Margin Alert - RED highlighting */
        .margin-alert { background-color: #fecaca !important; }
        .margin-alert:hover { background-color: #fca5a5 !important; }
        
        /* Competitive Price - GREEN highlighting */
        .competitive-price { background-color: #d1fae5 !important; }
        .competitive-price:hover { background-color: #a7f3d0 !important; }
        
        /* Table styles */
        table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        th { position: sticky; top: 0; background: #1f2937; color: white; z-index: 10; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #e5e7eb; overflow: hidden; text-overflow: ellipsis; }
        tr:hover { background-color: #f3f4f6 !important; }
        tbody { contain: layout; }
        
        /* Thumbnail */
        .thumb { width: 50px; height: 50px; object-fit: contain; cursor: pointer; }
        
        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal img { max-width: 90vw; max-height: 90vh; object-fit: contain; border-radius: 8px; }
        
        /* Search/Filter bar */
        .filter-bar { position: sticky; top: 0; background: white; z-index: 20; padding: 16px; border-bottom: 1px solid #e5e7eb; }
        
        /* Tabs */
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #2563eb; color: #2563eb; font-weight: 600; }
        .tab:hover { background-color: #f3f4f6; }
        
        /* Alert badge */
        .alert-badge { background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 9999px; font-size: 12px; margin-left: 4px; }
        
        @media print {
            .filter-bar, .no-print { display: none; }
            th { background: #374151 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .margin-alert { background: #fecaca !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <img id="modalImage" src="" alt="Product Image">
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar shadow-sm">
        <div class="max-w-full mx-auto flex flex-wrap items-center gap-4">
            <img src="logo.png" alt="Kande VendTech" class="h-12">
            <h1 class="text-xl font-bold text-gray-800">Product Export</h1>
            
            <input type="text" id="searchInput" placeholder="Search products..." 
                   class="px-4 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <select id="categoryFilter" class="px-4 py-2 border rounded-lg focus:outline-none">
                <option value="">All Categories</option>
                <option value="snacks">Snacks</option>
                <option value="candy">Candy</option>
                <option value="cold_beverage">Beverages</option>
                <option value="hot_foods">Hot Foods</option>
                <option value="refrigerated">Refrigerated</option>
                <option value="frozen_foods">Frozen Foods</option>
            </select>
            
            <span id="productCount" class="text-sm text-gray-500">0 products</span>
            
            <button onclick="exportCSV()" class="ml-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 no-print">
                üì• Export CSV
            </button>
            <button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 no-print">
                üñ®Ô∏è Print
            </button>
            <a href="index.html" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 no-print">
                ‚Üê Back to Catalog
            </a>
        </div>
        
        <!-- Tabs -->
        <div class="max-w-full mx-auto mt-4 flex gap-2 border-b no-print">
            <div class="tab active" data-tab="all" onclick="switchTab('all')">
                üì¶ All Products
            </div>
            <div class="tab" data-tab="competitive" onclick="switchTab('competitive')">
                üí∞ Competitive Pricing
                <span id="competitiveCount" class="bg-green-500 text-white px-2 py-0.5 rounded-full text-xs ml-1">0</span>
            </div>
            <div class="tab" data-tab="alerts" onclick="switchTab('alerts')">
                ‚ö†Ô∏è Margin Alerts
                <span id="alertCount" class="alert-badge">0</span>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="max-w-full mx-auto px-4 py-2 flex flex-wrap gap-2 text-sm no-print">
        <span class="px-3 py-1 rounded cat-snacks">Snacks</span>
        <span class="px-3 py-1 rounded cat-candy">Candy</span>
        <span class="px-3 py-1 rounded cat-cold_beverage">Beverages</span>
        <span class="px-3 py-1 rounded cat-hot_foods">Hot Foods</span>
        <span class="px-3 py-1 rounded cat-refrigerated">Refrigerated</span>
        <span class="px-3 py-1 rounded cat-frozen_foods">Frozen Foods</span>
        <span class="px-3 py-1 rounded competitive-price border border-green-400">‚úì 7-Eleven Competitive</span>
        <span class="px-3 py-1 rounded margin-alert border border-red-400">‚ö†Ô∏è Margin Alert</span>
    </div>

    <!-- Alert Banner (shown when there are margin alerts) -->
    <div id="alertBanner" class="hidden max-w-full mx-auto px-4 py-3 bg-red-100 border-l-4 border-red-500 text-red-700 no-print">
        <div class="flex items-center">
            <span class="text-xl mr-2">‚ö†Ô∏è</span>
            <div>
                <p class="font-bold">Margin Alert Products Detected</p>
                <p class="text-sm" id="alertBannerText">Some products have competitive prices below wholesale cost. These are highlighted in red.</p>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="overflow-x-auto">
        <table id="productTable">
            <thead>
                <tr>
                    <th class="w-16">Image</th>
                    <th>Brand</th>
                    <th>Product Name</th>
                    <th>Size</th>
                    <th>Category</th>
                    <th class="text-right">Wholesale</th>
                    <th class="text-right">7-Eleven Price</th>
                    <th class="text-right">Vending Price</th>
                    <th class="text-right">Margin</th>
                    <th class="text-right">Status</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <script src="products.js?v=17"></script>
    <script>
        // 7-Eleven prices for margin alert detection
        const sevenElevenPrices = {
            'snickers': { keywords: ['snickers', 'singles'], price: 2.99 },
            'butterfinger': { keywords: ['butterfinger', 'singles', '1.9'], price: 2.99 },
            'babyruth': { keywords: ['baby ruth', 'babyruth', 'singles'], price: 2.99 },
            'crunch': { keywords: ['crunch', 'single', '1.55'], price: 2.99 },
            '3musketeers': { keywords: ['3 musketeers', 'muskete', 'singles', '1.92'], price: 2.99 },
            'milkyway': { keywords: ['milky way', 'milkyway', 'singles'], price: 2.99 },
            'hershey-milk': { keywords: ['hershey', 'milk', 'chocolate', 'rtl', '1.55'], price: 2.99 },
            'doritos': { keywords: ['doritos', '2.75'], price: 2.69 },
            'lays': { keywords: ['lays', 'lay', '2.6'], price: 2.69 },
            'cheetos': { keywords: ['cheetos', '2'], price: 2.69 },
            'ruffles': { keywords: ['ruffles', '2.5'], price: 2.69 },
            'pringles': { keywords: ['pringles', '2.5', '2.3'], price: 2.49 },
            'takis': { keywords: ['takis', 'fuego'], price: 2.69 },
            'bugles': { keywords: ['bugles', 'original', '3'], price: 3.29 },
            'andycapps': { keywords: ['andy', 'capp', 'hot', 'fries'], price: 2.09 },
            'coke-20': { keywords: ['coca', 'cola', 'coke', '20'], price: 3.29 },
            'dietcoke-20': { keywords: ['diet', 'coke', '20'], price: 3.29 },
            'sprite-20': { keywords: ['sprite', '20'], price: 3.29 },
            'pepsi-20': { keywords: ['pepsi', '20'], price: 3.29 },
            'drpepper-20': { keywords: ['dr', 'pepper', '20'], price: 3.29 },
            'redbull-8': { keywords: ['red', 'bull', '8.4'], price: 3.49 },
            'redbull-16': { keywords: ['red', 'bull', '16'], price: 5.09 },
            'monster-16': { keywords: ['monster', '16'], price: 3.89 },
            'rockstar-16': { keywords: ['rockstar', '16'], price: 3.49 },
            'celsius': { keywords: ['celsius', '12'], price: 3.39 },
            'dasani': { keywords: ['dasani', '20'], price: 2.79 },
            'smartwater': { keywords: ['smart', 'water', '20'], price: 3.29 },
            'gatorade': { keywords: ['gatorade', '20'], price: 3.29 },
        };

        let allProducts = [];
        let filteredProducts = [];
        let currentTab = 'all';

        // Match product to 7-Eleven price
        function getSevenElevenPrice(product) {
            const name = product.name.toLowerCase();
            const size = product.size.toLowerCase();
            const combined = name + ' ' + size;
            
            for (const [key, item] of Object.entries(sevenElevenPrices)) {
                if (item.keywords.every(kw => combined.includes(kw.toLowerCase()))) {
                    return item.price;
                }
            }
            return null;
        }

        // Check if product has margin alert (7-Eleven price + $0.25 <= wholesale)
        function isMarginAlert(product) {
            const sePrice = getSevenElevenPrice(product);
            if (sePrice === null) return false;
            return (sePrice + 0.25) <= product.unitPrice;
        }

        // Check if product has competitive pricing override
        function hasCompetitivePrice(product) {
            return product.vendingPriceOverride && product.vendingPriceOverride > product.unitPrice;
        }

        // Vending price calculation
        function calculateVendingPrice(unitPrice, competitivePrice) {
            // Minimum 100% markup (2x wholesale)
            const minPrice = unitPrice * 2;
            
            // Use 7-Eleven competitive pricing if available and above minimum
            if (competitivePrice && competitivePrice >= minPrice) {
                return competitivePrice;
            }
            
            let rawPrice;
            if (unitPrice < 1) rawPrice = Math.ceil(unitPrice * 3.25 * 4) / 4;
            else if (unitPrice < 2) rawPrice = Math.ceil(unitPrice * 2.75 * 4) / 4;
            else if (unitPrice < 4) rawPrice = Math.ceil(unitPrice * 2.5 * 4) / 4;
            else rawPrice = Math.ceil(unitPrice * 2.25 * 4) / 4;
            
            // Enforce minimum 100% markup
            return Math.max(rawPrice, minPrice);
        }

        function formatPrice(price) {
            return '$' + price.toFixed(2);
        }

        function getCategoryClass(category) {
            return 'cat-' + (category || 'snacks');
        }

        function getCategoryName(category) {
            const names = {
                'snacks': 'Snacks',
                'candy': 'Candy',
                'cold_beverage': 'Beverages',
                'beverages': 'Beverages',
                'hot_foods': 'Hot Foods',
                'refrigerated': 'Refrigerated',
                'frozen_foods': 'Frozen Foods'
            };
            return names[category] || category;
        }

        function openModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            filterProducts();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            tbody.innerHTML = filteredProducts.map(p => {
                const vendingPrice = calculateVendingPrice(p.unitPrice, p.vendingPriceOverride);
                const margin = vendingPrice - p.unitPrice;
                const sePrice = getSevenElevenPrice(p);
                const isAlert = isMarginAlert(p);
                const hasCompetitive = hasCompetitivePrice(p);
                
                // Determine row class
                let rowClass = getCategoryClass(p.category);
                let status = '-';
                let statusClass = 'text-gray-400';
                
                if (isAlert) {
                    rowClass = 'margin-alert';
                    status = '‚ö†Ô∏è ALERT';
                    statusClass = 'text-red-600 font-bold';
                } else if (hasCompetitive) {
                    rowClass = 'competitive-price';
                    status = '‚úì Competitive';
                    statusClass = 'text-green-600 font-medium';
                }
                
                return `
                    <tr class="${rowClass}">
                        <td>
                            <img src="${p.imageUrl || ''}" 
                                 alt="${p.name}" 
                                 class="thumb"
                                 onclick="openModal('${p.imageUrl || ''}')"
                                 onerror="this.style.display='none'">
                        </td>
                        <td class="font-medium">${p.brand}</td>
                        <td>${p.name}</td>
                        <td class="text-gray-600">${p.size}</td>
                        <td><span class="px-2 py-1 rounded text-xs font-medium ${getCategoryClass(p.category)}">${getCategoryName(p.category)}</span></td>
                        <td class="text-right font-mono">${formatPrice(p.unitPrice)}</td>
                        <td class="text-right font-mono ${sePrice ? '' : 'text-gray-300'}">${sePrice ? formatPrice(sePrice) : '-'}</td>
                        <td class="text-right font-mono font-bold">${formatPrice(vendingPrice)}</td>
                        <td class="text-right font-mono ${margin > 0 ? 'text-green-600' : 'text-red-600'}">${formatPrice(margin)}</td>
                        <td class="text-right ${statusClass}">${status}</td>
                    </tr>
                `;
            }).join('');

            document.getElementById('productCount').textContent = filteredProducts.length + ' products';
        }

        function filterProducts() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;

            filteredProducts = allProducts.filter(p => {
                // Text/category filter
                const matchesSearch = !search || 
                    p.name.toLowerCase().includes(search) || 
                    p.brand.toLowerCase().includes(search);
                const matchesCategory = !category || p.category === category || 
                    (category === 'cold_beverage' && p.category === 'beverages');
                
                if (!matchesSearch || !matchesCategory) return false;
                
                // Tab filter
                if (currentTab === 'competitive') {
                    return hasCompetitivePrice(p);
                } else if (currentTab === 'alerts') {
                    return isMarginAlert(p);
                }
                return true;
            });

            renderTable();
        }

        function updateCounts() {
            const competitive = allProducts.filter(hasCompetitivePrice).length;
            const alerts = allProducts.filter(isMarginAlert).length;
            
            document.getElementById('competitiveCount').textContent = competitive;
            document.getElementById('alertCount').textContent = alerts;
            
            // Show/hide alert banner
            const alertBanner = document.getElementById('alertBanner');
            if (alerts > 0) {
                alertBanner.classList.remove('hidden');
                document.getElementById('alertBannerText').textContent = 
                    `${alerts} product(s) have 7-Eleven prices that would result in loss if matched. These are highlighted in red and NOT auto-priced.`;
            } else {
                alertBanner.classList.add('hidden');
            }
        }

        function exportCSV() {
            const headers = ['Brand', 'Product Name', 'Size', 'Category', 'Wholesale', '7-Eleven Price', 'Vending Price', 'Margin', 'Status', 'Image URL'];
            
            const rows = filteredProducts.map(p => {
                const vendingPrice = calculateVendingPrice(p.unitPrice, p.vendingPriceOverride);
                const margin = vendingPrice - p.unitPrice;
                const sePrice = getSevenElevenPrice(p);
                const isAlert = isMarginAlert(p);
                const hasCompetitive = hasCompetitivePrice(p);
                
                let status = '';
                if (isAlert) status = 'MARGIN ALERT';
                else if (hasCompetitive) status = 'Competitive';
                
                return [
                    `"${p.brand}"`,
                    `"${p.name}"`,
                    `"${p.size}"`,
                    `"${getCategoryName(p.category)}"`,
                    p.unitPrice.toFixed(2),
                    sePrice ? sePrice.toFixed(2) : '',
                    vendingPrice.toFixed(2),
                    margin.toFixed(2),
                    status,
                    p.imageUrl || ''
                ].join(',');
            });

            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kande-vendtech-products.csv';
            a.click();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof PRODUCTS !== 'undefined') {
                allProducts = PRODUCTS;
                filteredProducts = [...allProducts];
                updateCounts();
                renderTable();
            }

            document.getElementById('searchInput').addEventListener('input', filterProducts);
            document.getElementById('categoryFilter').addEventListener('change', filterProducts);
            
            // Close modal on Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        });
    </script>
</body>
</html>
